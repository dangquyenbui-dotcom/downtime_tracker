{% extends "base.html" %}

{% block title %}{{ _('Report Downtime') }}{% endblock %}

{% block styles %}
<style>
/* ============================================ */
/* RESPONSIVE DOWNTIME ENTRY FORM */
/* iPad Optimized with Dark Mode Support */
/* ============================================ */

/* Container Optimization */
.container-fluid {
    max-width: 1200px;
    margin: 0 auto;
    padding: 15px;
}

/* ============================================ */
/* HEADER SECTION */
/* ============================================ */
.downtime-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--gradient-primary);
    color: white;
    padding: 12px 16px;
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: var(--shadow-sm);
}

.header-info {
    display: flex;
    gap: 6px;
    align-items: center;
    font-size: 0.9em;
}

.header-label {
    opacity: 0.9;
    font-weight: 500;
}

.header-value {
    font-weight: 600;
}

.page-title {
    font-size: 1.6em;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--text-primary);
}

/* ============================================ */
/* FORM CONTAINER */
/* ============================================ */
.downtime-form {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-primary);
}

/* ============================================ */
/* FORM LAYOUT - OPTIMIZED SPACING */
/* ============================================ */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

/* ============================================ */
/* FORM LABELS */
/* ============================================ */
.form-label {
    font-weight: 600;
    font-size: 0.95em;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
}

.form-label i {
    color: var(--accent-blue);
}

.optional-badge {
    background: var(--accent-blue);
    color: white;
    font-size: 0.7em;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
    margin-left: 6px;
    opacity: 0.8;
}

/* ============================================ */
/* FORM INPUTS - DARK MODE COMPATIBLE */
/* ============================================ */
.form-select,
.form-control {
    min-height: 48px;
    padding: 10px 14px;
    border: 2px solid var(--border-primary);
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.2s ease;
    background: var(--input-bg);
    color: var(--text-primary);
    -webkit-appearance: none;
    appearance: none;
}

/* Light Mode - Select Dropdowns */
.form-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 40px;
}

/* Dark Mode - Select Dropdowns with Light Arrow */
[data-theme="dark"] .form-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23fff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
}

.form-select:focus,
.form-control:focus {
    outline: none;
    border-color: var(--accent-blue);
    background: var(--input-focus-bg);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

[data-theme="dark"] .form-select:focus,
[data-theme="dark"] .form-control:focus {
    box-shadow: 0 0 0 3px rgba(144, 205, 244, 0.1);
}

.form-select:disabled,
.form-control:disabled {
    background: var(--bg-tertiary);
    opacity: 0.6;
    cursor: not-allowed;
}

/* ============================================ */
/* DROPDOWN OPTIONS - CRITICAL FOR READABILITY */
/* ============================================ */

/* Light Mode - Dropdown Options */
.form-select option {
    background: #ffffff;
    color: #1a202c;
    padding: 10px;
    font-size: 16px;
}

.form-select option:hover,
.form-select option:focus,
.form-select option:checked {
    background: #667eea;
    color: #ffffff;
}

.form-select option:disabled {
    background: #f7fafc;
    color: #a0aec0;
}

/* Dark Mode - Dropdown Options */
[data-theme="dark"] .form-select option {
    background: #1a1a1a;
    color: #e2e8f0;
}

[data-theme="dark"] .form-select option:hover,
[data-theme="dark"] .form-select option:focus,
[data-theme="dark"] .form-select option:checked {
    background: #667eea;
    color: #ffffff;
}

[data-theme="dark"] .form-select option:disabled {
    background: #0a0a0a;
    color: #4a5568;
}

/* ============================================ */
/* TIME INPUTS */
/* ============================================ */
.time-group {
    grid-column: span 1;
}

.time-inputs {
    display: flex;
    align-items: center;
    gap: 8px;
}

.time-separator {
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.9em;
}

.form-text {
    margin-top: 3px;
    font-size: 0.85em;
    color: var(--text-tertiary);
}

/* ============================================ */
/* CREW SIZE CONTROL - TOUCH OPTIMIZED */
/* ============================================ */
.crew-size-control {
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-crew-adjust {
    min-width: 44px;
    min-height: 44px;
    border: 2px solid var(--accent-blue);
    background: var(--bg-secondary);
    color: var(--accent-blue);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-crew-adjust:hover {
    background: var(--accent-blue);
    color: white;
}

.btn-crew-adjust:active {
    transform: scale(0.95);
}

.crew-input {
    width: 70px;
    text-align: center;
    font-size: 22px;
    font-weight: 600;
    padding: 10px;
}

/* Number input arrows styling */
.crew-input::-webkit-inner-spin-button,
.crew-input::-webkit-outer-spin-button {
    opacity: 1;
}

[data-theme="dark"] .crew-input::-webkit-inner-spin-button,
[data-theme="dark"] .crew-input::-webkit-outer-spin-button {
    filter: invert(1);
}

.crew-range {
    color: var(--text-tertiary);
    font-size: 0.85em;
}

/* ============================================ */
/* JOB DETAILS CARD - DARK MODE */
/* ============================================ */
.job-details-card {
    background: var(--gradient-primary);
    border-radius: 10px;
    padding: 16px;
    margin: 12px 0;
    box-shadow: var(--shadow-md);
    animation: slideIn 0.3s ease-out;
}

[data-theme="dark"] .job-details-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-15px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.job-card-header {
    color: white;
    font-size: 1.1em;
    font-weight: 700;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.job-card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
}

.job-detail-item {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: 10px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.job-detail-label {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.8em;
    font-weight: 600;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.job-detail-value {
    color: white;
    font-size: 1em;
    font-weight: 600;
    word-break: break-word;
}

/* ============================================ */
/* DURATION DISPLAY */
/* ============================================ */
.duration-display {
    background: var(--accent-green);
    color: white;
    padding: 10px 14px;
    border-radius: 8px;
    margin: 12px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1em;
    font-weight: 600;
    box-shadow: var(--shadow-sm);
}

[data-theme="dark"] .duration-display {
    background: var(--accent-green);
}

.duration-value {
    font-size: 1.2em;
    font-weight: 700;
}

/* ============================================ */
/* QUICK NOTES - TOUCH OPTIMIZED */
/* ============================================ */
.quick-notes {
    margin: 12px 0;
}

.quick-notes-label {
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-secondary);
    font-size: 0.95em;
}

.quick-note-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.btn-quick-note {
    padding: 8px 14px;
    min-height: 44px;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-primary);
    color: var(--text-primary);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn-quick-note:hover {
    background: var(--accent-blue);
    color: white;
    border-color: var(--accent-blue);
}

.btn-quick-note:active {
    transform: scale(0.95);
}

/* ============================================ */
/* FORM ACTIONS - TOUCH OPTIMIZED */
/* ============================================ */
.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 2px solid var(--border-primary);
}

.btn {
    min-height: 50px;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 2px solid var(--border-primary);
}

.btn-secondary:hover {
    background: var(--bg-hover);
}

.btn-secondary:active {
    transform: scale(0.97);
}

.btn-primary {
    background: var(--gradient-primary);
    color: white;
    box-shadow: var(--shadow-sm);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-primary:active {
    transform: translateY(0);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* ============================================ */
/* TODAY'S ENTRIES */
/* ============================================ */
.todays-entries {
    margin-top: 25px;
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-primary);
}

.section-title {
    font-size: 1.3em;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.entries-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.entry-card {
    background: var(--bg-tertiary);
    border: 2px solid var(--border-primary);
    border-radius: 10px;
    padding: 14px;
    transition: all 0.2s ease;
}

.entry-card:hover {
    border-color: var(--accent-blue);
    box-shadow: var(--shadow-sm);
}

.entry-card.own-entry {
    border-left: 4px solid var(--accent-blue);
}

.entry-card.other-entry {
    opacity: 0.8;
}

.entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text-primary);
}

.entry-details {
    color: var(--text-secondary);
    font-size: 0.9em;
    margin-bottom: 6px;
}

.entry-notes {
    margin-top: 8px;
    font-size: 0.9em;
    color: var(--text-secondary);
    font-style: italic;
}

.entry-actions {
    margin-top: 10px;
    display: flex;
    gap: 8px;
}

.btn-sm {
    min-height: 38px;
    padding: 6px 12px;
    font-size: 14px;
}

/* ============================================ */
/* TEXTAREA - DARK MODE COMPATIBLE */
/* ============================================ */
textarea.form-control {
    resize: vertical;
    font-family: inherit;
    line-height: 1.5;
}

/* ============================================ */
/* DATETIME INPUT - DARK MODE COMPATIBLE */
/* ============================================ */
input[type="datetime-local"] {
    color-scheme: light;
}

[data-theme="dark"] input[type="datetime-local"] {
    color-scheme: dark;
}

/* Webkit-specific datetime picker styling */
input[type="datetime-local"]::-webkit-calendar-picker-indicator {
    filter: none;
    cursor: pointer;
}

[data-theme="dark"] input[type="datetime-local"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
}

/* ============================================ */
/* RESPONSIVE - MOBILE/TABLET */
/* ============================================ */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .time-inputs {
        flex-direction: column;
        gap: 10px;
    }
    
    .time-separator {
        display: none;
    }
    
    .job-card-grid {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
    
    .downtime-header {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
    }
}

/* ============================================ */
/* LOADING ANIMATION */
/* ============================================ */
@keyframes spin {
    to { transform: rotate(360deg); }
}

.fa-spinner {
    animation: spin 1s linear infinite;
}

/* ============================================ */
/* ALERTS */
/* ============================================ */
.alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 14px;
    border: 1px solid;
}

.alert-success {
    background: var(--alert-success-bg);
    color: var(--alert-success-text);
    border-color: var(--alert-success-border);
}

.alert-error {
    background: var(--alert-error-bg);
    color: var(--alert-error-text);
    border-color: var(--alert-error-border);
}

.alert-info {
    background: var(--alert-info-bg);
    color: var(--alert-info-text);
    border-color: var(--alert-info-border);
}

/* ============================================ */
/* PLACEHOLDER TEXT - DARK MODE */
/* ============================================ */
::placeholder {
    color: var(--text-tertiary);
    opacity: 0.6;
}

[data-theme="dark"] ::placeholder {
    color: var(--text-tertiary);
    opacity: 0.5;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="downtime-header">
        <div class="header-info">
            <span class="header-label">{{ _('DATE/TIME') }}:</span>
            <span class="header-value" id="current-datetime"></span>
        </div>
        <div class="header-info">
            <span class="header-label">{{ _('SHIFT') }}:</span>
            <span class="header-value">{{ current_shift.shift_name if current_shift else _('N/A') }}</span>
        </div>
        <div class="header-info">
            <span class="header-label">{{ _('USER') }}:</span>
            <span class="header-value">{{ user.display_name or user.username }}</span>
        </div>
    </div>

    <h2 class="page-title">{{ _('Report Production Downtime') }}</h2>

    <!-- Alert Container -->
    <div id="alert-container"></div>

    <!-- Downtime Entry Form -->
    <form id="downtime-form" class="downtime-form">
        <input type="hidden" id="downtime_id" name="downtime_id" value="">
        
        <div class="form-row">
            <!-- Facility -->
            <div class="form-group">
                <label for="facility_id" class="form-label">
                    <i class="fas fa-building"></i> {{ _('Facility') }} *
                </label>
                <select id="facility_id" name="facility_id" class="form-select" required>
                    <option value="">{{ _('Select Facility...') }}</option>
                    {% for facility in facilities %}
                    <option value="{{ facility.facility_id }}">{{ facility.facility_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Production Line -->
            <div class="form-group">
                <label for="line_id" class="form-label">
                    <i class="fas fa-industry"></i> {{ _('Production Line') }} *
                </label>
                <select id="line_id" name="line_id" class="form-select" required disabled>
                    <option value="">{{ _('Select Production Line...') }}</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <!-- Time Range -->
            <div class="form-group time-group">
                <label class="form-label">
                    <i class="fas fa-clock"></i> {{ _('Time Range') }} *
                </label>
                <div class="time-inputs">
                    <input type="datetime-local" id="start_time" name="start_time" class="form-control" required>
                    <span class="time-separator">{{ _('to') }}</span>
                    <input type="datetime-local" id="end_time" name="end_time" class="form-control" required>
                </div>
                <small class="form-text">{{ _('Auto-filled to last 30 minutes') }}</small>
            </div>

            <!-- Crew Size -->
            <div class="form-group">
                <label for="crew_size" class="form-label">
                    <i class="fas fa-users"></i> {{ _('Associates (Crew)') }} *
                </label>
                <div class="crew-size-control">
                    <button type="button" class="btn-crew-adjust" id="crew-decrease">
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" id="crew_size" name="crew_size" class="form-control crew-input" 
                           value="2" min="1" max="10" required>
                    <button type="button" class="btn-crew-adjust" id="crew-increase">
                        <i class="fas fa-plus"></i>
                    </button>
                    <span class="crew-range">(1-10)</span>
                </div>
            </div>
        </div>

        <!-- ERP JOB SELECTION -->
        <div class="form-row">
            <div class="form-group">
                <label for="job_number" class="form-label">
                    <i class="fas fa-briefcase"></i> {{ _('Job Number') }}
                    <span class="optional-badge">{{ _('Optional') }}</span>
                </label>
                <select id="job_number" name="job_number" class="form-select" disabled>
                    <option value="">{{ _('Select a job...') }}</option>
                </select>
                <small id="job-loading" class="form-text" style="display: none; color: var(--accent-blue);">
                    <i class="fas fa-spinner fa-spin"></i> {{ _('Loading jobs from ERP...') }}
                </small>
                <small class="form-text">{{ _('Select facility and line first to load jobs') }}</small>
            </div>

            <!-- Shift -->
            <div class="form-group">
                <label for="shift_id" class="form-label">
                    <i class="fas fa-sun"></i> {{ _('Shift') }}
                </label>
                <select id="shift_id" name="shift_id" class="form-select">
                    <option value="">{{ _('Auto-detect') }}</option>
                    {% for shift in shifts %}
                    <option value="{{ shift.shift_id }}" {% if current_shift and shift.shift_id == current_shift.shift_id %}selected{% endif %}>
                        {{ shift.shift_name }} ({{ shift.start_time }} - {{ shift.end_time }})
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Job Details Card -->
        <div id="job-details-card" class="job-details-card" style="display: none;">
            <div class="job-card-header">
                <i class="fas fa-info-circle"></i> {{ _('Job Details') }}
            </div>
            <div class="job-card-grid">
                <div class="job-detail-item">
                    <div class="job-detail-label">{{ _('Job Number') }}</div>
                    <div id="display-job-number" class="job-detail-value">-</div>
                </div>
                <div class="job-detail-item">
                    <div class="job-detail-label">{{ _('Part Number') }}</div>
                    <div id="display-part-number" class="job-detail-value">-</div>
                </div>
                <div class="job-detail-item">
                    <div class="job-detail-label">{{ _('Part Description') }}</div>
                    <div id="display-part-description" class="job-detail-value">-</div>
                </div>
                <div class="job-detail-item">
                    <div class="job-detail-label">{{ _('Customer') }}</div>
                    <div id="display-customer" class="job-detail-value">-</div>
                </div>
                <div class="job-detail-item">
                    <div class="job-detail-label">{{ _('Business Unit') }}</div>
                    <div id="display-business-unit" class="job-detail-value">-</div>
                </div>
                <div id="sales-order-section" class="job-detail-item" style="display: none;">
                    <div class="job-detail-label">{{ _('Sales Order') }}</div>
                    <div id="display-sales-order" class="job-detail-value">-</div>
                </div>
            </div>
        </div>

        <!-- Hidden fields for job data -->
        <input type="hidden" id="erp_job_number" name="erp_job_number" value="">
        <input type="hidden" id="erp_part_number" name="erp_part_number" value="">
        <input type="hidden" id="erp_part_description" name="erp_part_description" value="">

        <!-- DOWNTIME CATEGORIES -->
        <div class="form-row">
            <!-- Main Category -->
            <div class="form-group">
                <label for="main_category" class="form-label">
                    <i class="fas fa-list"></i> {{ _('Main Category') }} *
                </label>
                <select id="main_category" name="main_category" class="form-select" required>
                    <option value="">{{ _('Select Main Category...') }}</option>
                    {% for category in categories %}
                    <option value="{{ category.category_id }}" 
                            data-color="{{ category.color_code or '#667eea' }}">
                        {{ category.category_code }} - {{ category.category_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Sub Category -->
            <div class="form-group">
                <label for="category_id" class="form-label">
                    <i class="fas fa-tag"></i> {{ _('Sub Category') }} *
                </label>
                <select id="category_id" name="category_id" class="form-select" required disabled>
                    <option value="">{{ _('Select Main First...') }}</option>
                </select>
            </div>
        </div>

        <!-- Duration Display -->
        <div class="duration-display" id="duration-display" style="display: none;">
            <i class="fas fa-stopwatch"></i>
            <span>{{ _('Duration') }}: </span>
            <span id="duration-value" class="duration-value">0 {{ _('minutes') }}</span>
        </div>

        <!-- Comments -->
        <div class="form-group">
            <label for="comments" class="form-label">
                <i class="fas fa-comment"></i> {{ _('Comments / Additional Information') }}
            </label>
            <textarea id="comments" name="comments" class="form-control" rows="3" 
                      placeholder="{{ _('Enter any additional details about the downtime...') }}"></textarea>
        </div>

        <!-- Quick Notes -->
        <div class="quick-notes">
            <div class="quick-notes-label">{{ _('Quick Notes') }}:</div>
            <div class="quick-note-buttons">
                <button type="button" class="btn-quick-note" data-note="{{ _('Parts') }}">{{ _('Parts') }}</button>
                <button type="button" class="btn-quick-note" data-note="{{ _('Maintenance') }}">{{ _('Maintenance') }}</button>
                <button type="button" class="btn-quick-note" data-note="{{ _('Quality') }}">{{ _('Quality') }}</button>
                <button type="button" class="btn-quick-note" data-note="{{ _('Changeover') }}">{{ _('Changeover') }}</button>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="btn-clear">
                <i class="fas fa-times"></i> {{ _('Clear') }}
            </button>
            <button type="submit" class="btn btn-primary" id="btn-submit">
                <i class="fas fa-save"></i> {{ _('Submit Downtime') }}
            </button>
        </div>
    </form>

    <!-- Today's Entries -->
    <div class="todays-entries" id="todays-entries" style="display: none;">
        <h3 class="section-title">
            <i class="fas fa-list-ul"></i> {{ _("Today's Downtime Entries") }}
        </h3>
        <div id="entries-list" class="entries-list">
            <!-- Entries will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ============================================
// DOWNTIME ENTRY FORM - COMPLETE JAVASCRIPT
// ============================================

console.log('✅ Downtime entry form loading...');

// Global variables
let availableJobs = [];
let currentLineId = null;
let allCategories = {{ categories | tojson | safe }};

// Translation strings
const translations = {
    'Authenticating': '{{ _("Authenticating...") }}',
    'Submitting': '{{ _("Submitting...") }}',
    'Success': '{{ _("Success") }}',
    'Error': '{{ _("Error") }}',
    'minutes': '{{ _("minutes") }}',
    'DeleteConfirm': '{{ _("Are you sure you want to delete this entry?") }}',
    'EntryDeleted': '{{ _("Entry deleted") }}',
    'Edit': '{{ _("Edit") }}',
    'Delete': '{{ _("Delete") }}',
    'SubmitDowntime': '{{ _("Submit Downtime") }}'
};

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM ready, initializing form...');
    
    initializeDateTimeFields();
    attachEventListeners();
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    console.log('✅ Form initialized');
});

// ============================================
// DATE/TIME FUNCTIONS
// ============================================

function updateDateTime() {
    const now = new Date();
    const options = { 
        month: 'short', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    };
    document.getElementById('current-datetime').textContent = 
        now.toLocaleDateString('{{ get_locale() }}', options).replace(',', ' ');
}

function initializeDateTimeFields() {
    const now = new Date();
    const thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000);
    
    document.getElementById('start_time').value = formatDateTimeLocal(thirtyMinutesAgo);
    document.getElementById('end_time').value = formatDateTimeLocal(now);
    
    updateDuration();
}

function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function updateDuration() {
    const start = new Date(document.getElementById('start_time').value);
    const end = new Date(document.getElementById('end_time').value);
    
    if (start && end && end > start) {
        const minutes = Math.round((end - start) / 60000);
        document.getElementById('duration-value').textContent = `${minutes} ${translations.minutes}`;
        document.getElementById('duration-display').style.display = 'flex';
    } else {
        document.getElementById('duration-display').style.display = 'none';
    }
}

// ============================================
// EVENT LISTENERS
// ============================================

function attachEventListeners() {
    document.getElementById('facility_id').addEventListener('change', handleFacilityChange);
    document.getElementById('line_id').addEventListener('change', handleLineChange);
    document.getElementById('job_number').addEventListener('change', handleJobSelection);
    document.getElementById('main_category').addEventListener('change', handleMainCategoryChange);
    document.getElementById('start_time').addEventListener('change', updateDuration);
    document.getElementById('end_time').addEventListener('change', updateDuration);
    document.getElementById('crew-decrease').addEventListener('click', () => adjustCrewSize(-1));
    document.getElementById('crew-increase').addEventListener('click', () => adjustCrewSize(1));
    
    document.querySelectorAll('.btn-quick-note').forEach(btn => {
        btn.addEventListener('click', function() {
            const note = this.dataset.note;
            const commentsField = document.getElementById('comments');
            commentsField.value = (commentsField.value ? commentsField.value + '\n' : '') + note;
        });
    });
    
    document.getElementById('btn-clear').addEventListener('click', clearForm);
    document.getElementById('downtime-form').addEventListener('submit', handleFormSubmit);
}

// ============================================
// FACILITY & LINE HANDLING
// ============================================

function handleFacilityChange() {
    const facilityId = this.value;
    const lineSelect = document.getElementById('line_id');
    const jobSelect = document.getElementById('job_number');
    const jobCard = document.getElementById('job-details-card');
    
    lineSelect.innerHTML = '<option value="">{{ _("Select Production Line...") }}</option>';
    lineSelect.disabled = true;
    
    jobSelect.innerHTML = '<option value="">{{ _("Select a job...") }}</option>';
    jobSelect.disabled = true;
    if (jobCard) jobCard.style.display = 'none';
    clearJobFields();
    
    if (!facilityId) return;
    
    fetch(`/downtime/api/lines/${facilityId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.lines) {
                data.lines.forEach(line => {
                    const option = document.createElement('option');
                    option.value = line.id;
                    option.textContent = line.name;
                    lineSelect.appendChild(option);
                });
                lineSelect.disabled = false;
            }
        })
        .catch(error => console.error('Error loading lines:', error));
}

function handleLineChange() {
    const lineId = this.value;
    currentLineId = lineId;
    
    const jobSelect = document.getElementById('job_number');
    const jobCard = document.getElementById('job-details-card');
    
    jobSelect.innerHTML = '<option value="">{{ _("Select a job...") }}</option>';
    jobSelect.disabled = true;
    if (jobCard) jobCard.style.display = 'none';
    clearJobFields();
    
    if (!lineId) return;
    
    loadTodaysEntries(lineId);
    loadJobsForLine();
}

// ============================================
// ERP JOB LOADING
// ============================================

function loadJobsForLine() {
    const facilitySelect = document.getElementById('facility_id');
    const lineSelect = document.getElementById('line_id');
    const jobSelect = document.getElementById('job_number');
    const jobLoading = document.getElementById('job-loading');
    
    const facilityName = facilitySelect.options[facilitySelect.selectedIndex].text;
    const lineName = lineSelect.options[lineSelect.selectedIndex].text;
    
    console.log(`📡 Loading ERP jobs for ${facilityName}/${lineName}`);
    
    if (jobLoading) jobLoading.style.display = 'block';
    
    fetch(`/api/erp/open-jobs/${encodeURIComponent(facilityName)}/${encodeURIComponent(lineName)}`)
        .then(response => response.json())
        .then(data => {
            if (jobLoading) jobLoading.style.display = 'none';
            
            if (data.success && data.jobs && data.jobs.length > 0) {
                availableJobs = data.jobs;
                console.log(`✅ Loaded ${data.jobs.length} jobs`);
                
                data.jobs.forEach(job => {
                    const option = document.createElement('option');
                    option.value = job.JobNumber;
                    option.textContent = `${job.JobNumber} - ${job.PartNumber}`;
                    option.dataset.jobData = JSON.stringify(job);
                    jobSelect.appendChild(option);
                });
                
                jobSelect.disabled = false;
            } else {
                console.log('ℹ️ No jobs found');
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '{{ _("No open jobs for this line") }}';
                option.disabled = true;
                jobSelect.appendChild(option);
            }
        })
        .catch(error => {
            console.error('❌ Error loading jobs:', error);
            if (jobLoading) jobLoading.style.display = 'none';
            
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '{{ _("Error loading jobs (optional)") }}';
            option.disabled = true;
            jobSelect.appendChild(option);
            
            jobSelect.disabled = false;
        });
}

function handleJobSelection() {
    const jobSelect = this;
    const selectedOption = jobSelect.options[jobSelect.selectedIndex];
    const jobCard = document.getElementById('job-details-card');
    
    if (jobSelect.value && selectedOption.dataset.jobData) {
        const jobData = JSON.parse(selectedOption.dataset.jobData);
        console.log('✅ Job selected:', jobData);
        
        document.getElementById('display-job-number').textContent = jobData.JobNumber || '-';
        document.getElementById('display-part-number').textContent = jobData.PartNumber || 'N/A';
        document.getElementById('display-part-description').textContent = jobData.PartDescription || 'N/A';
        document.getElementById('display-customer').textContent = jobData.Customer || 'N/A';
        document.getElementById('display-business-unit').textContent = jobData.s_BU || 'N/A';
        
        const salesOrderSection = document.getElementById('sales-order-section');
        if (jobData.SalesOrder && jobData.SalesOrder !== '') {
            document.getElementById('display-sales-order').textContent = jobData.SalesOrder;
            salesOrderSection.style.display = 'block';
        } else {
            salesOrderSection.style.display = 'none';
        }
        
        document.getElementById('erp_job_number').value = jobData.JobNumber || '';
        document.getElementById('erp_part_number').value = jobData.PartNumber || '';
        document.getElementById('erp_part_description').value = jobData.PartDescription || '';
        
        jobCard.style.display = 'block';
    } else {
        jobCard.style.display = 'none';
        clearJobFields();
    }
}

function clearJobFields() {
    document.getElementById('erp_job_number').value = '';
    document.getElementById('erp_part_number').value = '';
    document.getElementById('erp_part_description').value = '';
}

// ============================================
// CATEGORY HANDLING
// ============================================

function handleMainCategoryChange() {
    const mainCategoryId = parseInt(this.value);
    const subCategorySelect = document.getElementById('category_id');
    
    subCategorySelect.innerHTML = '<option value="">{{ _("Select Sub Category...") }}</option>';
    subCategorySelect.disabled = true;
    
    if (!mainCategoryId) return;
    
    const mainCategory = allCategories.find(cat => cat.category_id === mainCategoryId);
    if (!mainCategory || !mainCategory.subcategories) return;
    
    mainCategory.subcategories.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.category_id;
        option.textContent = `${sub.category_code} - ${sub.category_name}`;
        subCategorySelect.appendChild(option);
    });
    
    subCategorySelect.disabled = false;
}

// ============================================
// CREW SIZE ADJUSTMENT
// ============================================

function adjustCrewSize(delta) {
    const crewInput = document.getElementById('crew_size');
    let currentValue = parseInt(crewInput.value) || 2;
    let newValue = currentValue + delta;
    
    if (newValue >= 1 && newValue <= 10) {
        crewInput.value = newValue;
    }
}

// ============================================
// FORM SUBMISSION
// ============================================

function handleFormSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = document.getElementById('btn-submit');
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${translations.Submitting}`;
    
    fetch('/downtime/submit', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            clearForm();
            if (currentLineId) {
                loadTodaysEntries(currentLineId);
            }
        } else {
            showAlert(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('{{ _("Error submitting downtime entry") }}', 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = `<i class="fas fa-save"></i> ${translations.SubmitDowntime}`;
    });
}

// ============================================
// ALERT SYSTEM
// ============================================

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertContainer.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        alertDiv.style.transition = 'opacity 0.3s';
        setTimeout(() => alertDiv.remove(), 300);
    }, 5000);
}

// ============================================
// FORM CLEARING
// ============================================

function clearForm() {
    document.getElementById('downtime-form').reset();
    document.getElementById('downtime_id').value = '';
    
    document.getElementById('line_id').innerHTML = '<option value="">{{ _("Select Production Line...") }}</option>';
    document.getElementById('line_id').disabled = true;
    
    document.getElementById('job_number').innerHTML = '<option value="">{{ _("Select a job...") }}</option>';
    document.getElementById('job_number').disabled = true;
    
    const jobCard = document.getElementById('job-details-card');
    if (jobCard) jobCard.style.display = 'none';
    
    clearJobFields();
    
    document.getElementById('category_id').innerHTML = '<option value="">{{ _("Select Main First...") }}</option>';
    document.getElementById('category_id').disabled = true;
    
    initializeDateTimeFields();
    document.getElementById('crew_size').value = 2;
    
    console.log('✅ Form cleared');
}

// ============================================
// TODAY'S ENTRIES
// ============================================

function loadTodaysEntries(lineId) {
    fetch(`/downtime/api/today-entries/${lineId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.entries) {
                displayTodaysEntries(data.entries);
            }
        })
        .catch(error => console.error('Error loading entries:', error));
}

function displayTodaysEntries(entries) {
    const entriesSection = document.getElementById('todays-entries');
    const entriesList = document.getElementById('entries-list');
    
    if (!entries || entries.length === 0) {
        entriesSection.style.display = 'none';
        return;
    }
    
    entriesList.innerHTML = '';
    
    entries.forEach(entry => {
        const card = createEntryCard(entry);
        entriesList.appendChild(card);
    });
    
    entriesSection.style.display = 'block';
}

function createEntryCard(entry) {
    const div = document.createElement('div');
    div.className = `entry-card ${entry.is_own_entry ? 'own-entry' : 'other-entry'}`;
    
    const duration = entry.duration_minutes || 0;
    const enteredBy = entry.entered_by || 'Unknown';
    
    div.innerHTML = `
        <div class="entry-header">
            <strong>${entry.category_name}</strong>
            <span>${duration} {{ _('min') }}</span>
        </div>
        <div class="entry-details">
            ${entry.start_time_str} - ${entry.end_time_str} | 
            ${entry.shift_name || 'N/A'} | 
            {{ _('Crew') }}: ${entry.crew_size || 1}
            ${!entry.is_own_entry ? ` | 👤 ${enteredBy}` : ''}
        </div>
        ${entry.reason_notes ? `<div class="entry-notes">${entry.reason_notes}</div>` : ''}
        ${entry.is_own_entry ? `
            <div class="entry-actions">
                <button onclick="editEntry(${entry.downtime_id})" class="btn btn-secondary btn-sm">
                    <i class="fas fa-edit"></i> ${translations.Edit}
                </button>
                <button onclick="deleteEntry(${entry.downtime_id})" class="btn btn-secondary btn-sm" style="border-color: var(--accent-red); color: var(--accent-red);">
                    <i class="fas fa-trash"></i> ${translations.Delete}
                </button>
            </div>
        ` : ''}
    `;
    
    return div;
}

function editEntry(downtimeId) {
    console.log('Edit entry:', downtimeId);
    showAlert('{{ _("Edit functionality - to be implemented") }}', 'info');
}

function deleteEntry(downtimeId) {
    if (!confirm(translations.DeleteConfirm)) return;
    
    fetch(`/downtime/delete/${downtimeId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(translations.EntryDeleted, 'success');
            if (currentLineId) {
                loadTodaysEntries(currentLineId);
            }
        } else {
            showAlert(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('{{ _("Error deleting entry") }}', 'error');
    });
}

console.log('✅ Downtime entry form script loaded');
</script>
{% endblock %}